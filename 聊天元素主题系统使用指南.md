# 聊天元素主题系统使用指南

本指南详细说明如何使用聊天元素主题系统，包括角色显示功能、模板配置、开发规范等内容。

## 📋 目录

1. [系统架构概览](#-系统架构概览)
2. [角色显示功能](#-角色显示功能)
3. [模块系统说明](#-模块系统说明)
4. [配置文件详解](#-配置文件详解)
5. [LLM输出规范](#-llm输出规范)
6. [开发规范](#-开发规范)
7. [最佳实践](#-最佳实践)
8. [故障排除](#-故障排除)

---

## 🏗️ 系统架构概览

### 核心组件
```
cyberpunk2027-hubs/
├── index.js                    # 主扩展文件
├── themes-config.json          # 主题配置文件
└── chat-elements-themes/
    └── cyberpunk/
        ├── scene-container/    # 场景容器模块
        ├── combat-interface/   # 战斗界面模块
        ├── dialog-box/         # 对话框模块
        └── notification-bar/   # 通知栏模块
```

### 工作流程
1. **LLM输出** → 生成带有`data-*`属性的HTML元素
2. **模块识别** → 系统根据`data-type`属性选择对应模块
3. **数据提取** → 从HTML元素中提取数据属性
4. **模板渲染** → 使用模块的template.html进行渲染
5. **样式应用** → 应用template.css样式
6. **DOM插入** → 将渲染结果插入到聊天界面

---

## 🎭 角色显示功能

系统支持四种角色显示类型，每种都有其特定的用途和显示效果：

| 角色类型 | 配置标识 | 数据属性 | 显示效果 | 适用场景 |
|---------|---------|---------|---------|----------|
| **主角色** | `MAIN_CHAR_NAME`<br>`MAIN_CHAR_AVATAR` | 自动获取 | 当前对话角色 | 角色状态面板、对话界面 |
| **用户** | `USER_NAME`<br>`USER_AVATAR` | 自动获取 | 用户信息 | 用户状态、个人信息面板 |
| **NPC网络** | `NPC_LIST` | `data-npc-content` | 多头像网格 | 场景描述、关系网络 |
| **特定NPC** | `NPC_SPECIFIC` | `data-npc-specific` | 单个突出头像 | 战斗界面、对话目标 |

### 主角色显示 (MAIN_CHAR)

**功能**：自动获取当前聊天中的主要AI角色
**模板语法**：
```html
<img src="{{MAIN_CHAR_AVATAR}}" alt="主角色头像">
<span>{{MAIN_CHAR_NAME}}</span>
```

### 用户显示 (USER)

**功能**：自动获取当前用户信息
**模板语法**：
```html
<img src="{{USER_AVATAR}}" alt="用户头像">  
<span>{{USER_NAME}}</span>
```

### NPC网络显示 (NPC_LIST)

**功能**：显示多个NPC角色网络
**LLM输出格式**：
```html
<span data-type="scene-container" data-npc-content="张三,李四,王五"></span>
```

**模板语法**：
```html
{{#NPC_LIST}}
<div class="npc-item">
    <img src="{{avatar}}" alt="{{name}}">
    <span>{{name}}</span>
</div>
{{/NPC_LIST}}
```

### 特定NPC显示 (NPC_SPECIFIC)

**功能**：突出显示单个重要NPC
**LLM输出格式**：
```html
<span data-type="combat-interface" data-npc-specific="BOSS"></span>
```

**模板语法**：
```html
<div class="npc-specific">
    <img src="{{NPC_SPECIFIC_AVATAR}}" alt="{{NPC_SPECIFIC}}">
    <span>{{NPC_SPECIFIC}}</span>
</div>
```

---

## 🧩 模块系统说明

### 可用模块列表

#### 1. scene-container (场景容器)
**用途**：显示详细的场景信息
**支持的数据类型**：
- 环境信息（时间、地点、天气、事件）
- 角色信息（主角、用户、NPC网络、特定NPC）
- 角色状态（外观、服装、行为）

**LLM输出示例**：
```html
<span data-type="scene-container" 
      data-date="2077年3月15日" 
      data-time="14:30"
      data-location="夜之城商业区"
      data-weather="多云"
      data-temperature="18°C"
      data-event="街头抗议活动"
      data-character-looks="疲惫但警觉"
      data-character-wearing="黑色皮夹克和牛仔裤"
      data-character-behavior="谨慎观察周围"
      data-user-info="潜行专家"
      data-user-location="阴影中"
      data-user-activity="观察"
      data-npc-content="抗议者,警察,记者">
</span>
```

#### 2. combat-interface (战斗界面)
**用途**：显示战斗相关信息
**支持的数据类型**：
- 生命值、护甲值、体力值
- 武器信息、战斗状态
- 战斗目标NPC

**LLM输出示例**：
```html
<span data-type="combat-interface"
      data-health="85%"
      data-armor="60%" 
      data-stamina="70%"
      data-weapon="等离子步枪"
      data-ammo="24/120"
      data-combat-status="战斗中"
      data-npc-specific="赛博武士">
</span>
```

#### 3. dialog-box (对话框)
**用途**：显示NPC对话信息
**支持的数据类型**：
- NPC情绪、对话内容
- 关系状态、信任度

**LLM输出示例**：
```html
<span data-type="dialog-box"
      data-npc-name="神秘商人"
      data-npc-emotion="谨慎"
      data-dialog-content="你看起来像是能办事的人..."
      data-relationship="陌生人"
      data-trust-level="10%">
</span>
```

#### 4. notification-bar (通知栏)
**用途**：显示系统通知和提示
**支持的数据类型**：
- 通知类型、消息内容
- 优先级、持续时间

**LLM输出示例**：
```html
<span data-type="notification-bar"
      data-notification-type="warning"
      data-message="检测到敌对网络入侵!"
      data-priority="high"
      data-duration="5000">
</span>
```

---

## ⚙️ 配置文件详解

### themes-config.json (主题配置)

**位置**：`chat-elements-themes/themes-config.json`
**用途**：定义所有主题和模块的配置

```json
{
  "all_modules": [
    "scene-container",
    "combat-interface",
    "inventory-check",
    "character-status",
    "dialogue-panel",
    "map-display"
  ],
  "themes": {
    "cyberpunk": {
      "name": "赛博朋克 2027",
      "description": "电子风格",
      "author": "Muffin",
      "modules": {
        "scene-container": {
          "name": "场景容器",
          "description": "显示环境、角色和用户状态信息的面板",
          "enabled": true
        },
        "combat-interface": {
          "name": "战斗界面",
          "description": "显示武器、技能、伤害等战斗相关信息",
          "enabled": true
        }
      }
    }
  },
  "settings": {
    "default_theme": "cyberpunk",
    "version": "1.0"
  }
}
```

**字段说明**：
- `all_modules`：系统支持的所有模块列表
- `themes`：主题配置对象
  - `name`：主题显示名称
  - `description`：主题描述
  - `author`：主题作者
  - `modules`：该主题支持的模块配置
    - `name`：模块显示名称
    - `description`：模块功能描述
    - `enabled`：是否启用该模块
- `settings`：全局设置
  - `default_theme`：默认使用的主题
  - `version`：配置文件版本

### config.json (模块配置)

**位置**：每个模块文件夹内的`config.json`
**用途**：定义模块的数据映射和验证规则

```json
{
  "module_name": "scene-container",
  "display_name": "场景容器",
  "description": "显示详细的场景信息包括环境、角色状态等",
  "version": "1.0.0",
  "data_mapping": {
    "{{DATE_DATA}}": {
      "source": "llm",
      "attribute": "data-date",
      "required": false,
      "default": "",
      "description": "日期信息"
    },
    "{{NPC_LIST}}": {
      "source": "llm", 
      "attribute": "data-npc-content",
      "type": "array",
      "separator": ",",
      "required": false,
      "default": "",
      "description": "NPC角色列表"
    },
    "{{MAIN_CHAR_NAME}}": {
      "source": "auto",
      "type": "character",
      "attribute": "name",
      "required": false,
      "default": "",
      "description": "主角色名称"
    }
  },
  "validation": {
    "min_required_fields": 1,
    "ignore_unknown_attributes": true
  }
}
```

**data_mapping字段说明**：
- `source`：数据来源
  - `"llm"`：从LLM输出的属性获取
  - `"auto"`：自动从SillyTavern系统获取
  - `"derived"`：基于其他数据派生计算
- `type`：数据类型
  - `"array"`：数组类型，需要指定分隔符
  - `"character"`：角色类型
  - `"npc_lookup"`：NPC查找类型
- `attribute`：对应的HTML属性名或系统属性名
- `required`：是否为必需字段
- `default`：默认值

---

## 📝 LLM输出规范

### 基本格式
```html
<span data-type="模块名" data-属性1="值1" data-属性2="值2">可选的显示文本</span>
```

### 各模块输出规范

#### scene-container 输出规范
```html
<span data-type="scene-container"
      data-date="日期字符串"
      data-time="时间字符串"  
      data-location="地点描述"
      data-weather="天气状态"
      data-temperature="温度"
      data-event="事件描述"
      data-character-looks="角色外观"
      data-character-wearing="角色服装"
      data-character-behavior="角色行为"
      data-user-info="用户信息"
      data-user-location="用户位置"
      data-user-activity="用户活动"
      data-npc-content="NPC1,NPC2,NPC3"
      data-npc-specific="特定NPC名称">
场景描述文本（可选）
</span>
```

#### combat-interface 输出规范
```html
<span data-type="combat-interface"
      data-health="生命值百分比"
      data-armor="护甲值百分比"
      data-stamina="体力值百分比"
      data-weapon="武器名称"
      data-ammo="弹药信息"
      data-combat-status="战斗状态"
      data-npc-specific="战斗目标">
战斗描述文本（可选）
</span>
```

#### dialog-box 输出规范
```html
<span data-type="dialog-box"
      data-npc-name="NPC名称"
      data-npc-emotion="情绪状态"
      data-dialog-content="对话内容"
      data-relationship="关系状态"
      data-trust-level="信任度">
对话描述文本（可选）
</span>
```

#### notification-bar 输出规范
```html
<span data-type="notification-bar"
      data-notification-type="通知类型"
      data-message="通知消息"
      data-priority="优先级"
      data-duration="持续时间">
通知文本（可选）
</span>
```

---

## 📏 开发规范

### CSS命名规范

#### BEM命名约定
```css
/* 块(Block) */
.scene-container { }

/* 元素(Element) */
.scene-container__header { }
.scene-container__content { }

/* 修饰符(Modifier) */
.scene-container--active { }
.scene-container__header--large { }
```

#### 特定命名模式
```css
/* 模块容器 */
.模块名-container { }

/* 分区 */
.模块名-section { }

/* 元素 */
.模块名-element { }

/* 内容 */
.模块名-content { }

/* 状态修饰符 */
.模块名--状态名 { }
```

#### 示例：scene-container模块
```css
.scene-container { }
.scene-container .scene-status-frame { }
.scene-container .scene-section { }
.scene-container .scene-element { }
.scene-container .element-header { }
.scene-container .element-content { }
.scene-container .npc-list-content { }
.scene-container .npc-item { }
.scene-container .npc-avatar-wrapper { }
```

### HTML结构规范

#### 模块结构模板
```html
<div class="模块名-container" data-module="模块名">
    <div class="模块名-frame">
        <div class="模块名-section" data-section="分区名">
            <div class="section-header">
                <span class="section-icon">图标</span>
                <span class="section-title">标题</span>
            </div>
            <div class="section-content">
                <div class="模块名-element" data-element="元素名">
                    <div class="element-header">
                        <span class="element-icon">图标</span>
                        <span class="element-label">标签</span>
                    </div>
                    <div class="element-content">
                        内容区域
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

### 模板占位符规范

#### 命名约定
- 使用全大写字母
- 单词间用下划线分隔
- 使用双花括号包围
- 数组循环使用`{{#PLACEHOLDER}}...{{/PLACEHOLDER}}`格式

#### 示例
```html
<!-- 简单占位符 -->
{{USER_NAME}}
{{MAIN_CHAR_AVATAR}}
{{DATE_DATA}}

<!-- 数组循环占位符 -->
{{#NPC_LIST}}
<div class="npc-item">
    <span>{{name}}</span>
    <img src="{{avatar}}">
</div>
{{/NPC_LIST}}
```

---

## 💡 最佳实践

### 1. 模块选择指南
- **场景描述** → `scene-container`
- **战斗场面** → `combat-interface`
- **NPC对话** → `dialog-box`
- **系统提示** → `notification-bar`

### 2. 数据属性命名
- 使用有意义的名称
- 保持命名一致性
- 避免使用特殊字符
- 使用kebab-case格式（如：`data-npc-content`）

### 3. 模板设计原则
- 保持结构清晰
- 合理使用语义化标签
- 预留扩展空间
- 考虑响应式设计

### 4. 性能优化
- 避免过度使用动画
- 合理控制DOM节点数量
- 使用CSS而非JavaScript动画
- 图片使用适当的尺寸和格式

### 5. 用户体验
- 提供视觉反馈
- 保持界面一致性
- 确保可访问性
- 支持多种设备

---

## 🐛 故障排除

### 常见问题

#### Q: 模块不显示/渲染失败
**可能原因**：
- `data-type`属性值错误
- 模块配置文件缺失或格式错误
- 模板文件路径不正确

**解决方法**：
1. 检查`data-type`是否与模块文件夹名一致
2. 验证`config.json`格式是否正确
3. 确认`template.html`和`template.css`文件存在

#### Q: 角色头像不显示
**可能原因**：
- 角色名称与SillyTavern中的名称不匹配
- 角色未添加到角色库
- 网络连接问题

**解决方法**：
1. 确保角色名称完全匹配
2. 检查角色是否存在于SillyTavern中
3. 查看浏览器控制台的错误信息

#### Q: 数据占位符未被替换
**可能原因**：
- 占位符名称错误
- `data_mapping`配置错误
- 数据属性名称不匹配

**解决方法**：
1. 检查占位符是否在`data_mapping`中定义
2. 验证`attribute`字段是否与HTML属性匹配
3. 确认占位符格式正确（双花括号）

#### Q: CSS样式不生效
**可能原因**：
- CSS文件路径错误
- 选择器优先级问题
- CSS变量未定义

**解决方法**：
1. 检查`template.css`文件是否存在
2. 使用浏览器开发者工具检查样式冲突
3. 确认CSS变量在`themes-config.json`中定义

### 调试技巧

#### 1. 使用浏览器开发者工具
- 检查生成的HTML结构
- 查看CSS样式应用情况
- 监控JavaScript错误

#### 2. 查看控制台日志
系统会输出详细的调试信息：
```
[cyberpunk2027-hubs] TEMPLATE-DATA: LLM data data-npc-content: "张三,李四,王五"
[cyberpunk2027-hubs] TEMPLATE-RENDER: Rendered array {{NPC_LIST}} with 3 items
```

#### 3. 验证配置文件
使用JSON验证工具检查配置文件格式是否正确。

---

## 📞 技术支持

### 系统要求
- SillyTavern 版本：1.10.0+
- 浏览器：Chrome 90+, Firefox 88+, Safari 14+

### 更新日志
- v1.0.0：初始版本，支持基础模块功能
- 后续版本将添加更多模块和功能

---

*最后更新：2024年*
*版本：v1.0*
